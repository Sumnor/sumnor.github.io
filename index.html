<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Politics & War - Data Viewer</title>
  <style>
    /* === Your original style preserved & slightly cleaned === */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh;padding:20px;color:#fff}
    .container{max-width:1400px;margin:0 auto}
    header{text-align:center;color:white;margin-bottom:30px}
    h1{font-size:2.25rem;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .status-bar{background:rgba(255,255,255,.08);padding:12px;border-radius:10px;margin-bottom:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;backdrop-filter:blur(8px)}
    .status-item{display:flex;align-items:center;gap:10px;color:#fff}
    .status-indicator{width:10px;height:10px;border-radius:50%;background:#4caf50;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .tabs{display:flex;gap:10px;margin-bottom:0}
    .tab{padding:12px 20px;background:rgba(255,255,255,.12);border:none;border-radius:10px 10px 0 0;color:white;font-weight:600;cursor:pointer}
    .tab.active{background:#fff;color:#1e3c72}
    .content{background:#fff;border-radius:0 10px 10px 10px;padding:24px;color:#111;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .section{display:none}
    .section.active{display:block}
    .search-box{width:100%;padding:10px 14px;border-radius:8px;border:2px solid #e6e6e6;margin-bottom:12px;font-size:1rem}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:14px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:14px;border-radius:10px;text-align:center}
    .stat-value{font-size:1.6rem;font-weight:700}
    .stat-label{opacity:.9}
    .pagination{display:flex;justify-content:center;gap:8px;margin:12px 0;flex-wrap:wrap}
    .pagination button{padding:8px 12px;border-radius:6px;background:#667eea;border:none;color:#fff;cursor:pointer}
    .pagination button:disabled{background:#ccc;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    thead{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;position:sticky;top:0}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    tbody tr{cursor:pointer;transition:background .15s}
    tbody tr:hover{background:#f5f5f5}
    .details-row{display:none}
    .details-row.show{display:table-row}
    .details-cell{padding:18px!important;background:#f8f9fa;border-left:4px solid #667eea}
    .details-content{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .detail-group{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .detail-group h4{margin-bottom:8px;color:#667eea;border-bottom:2px solid #667eea;padding-bottom:6px}
    .detail-item{display:flex;justify-content:space-between;padding:6px 0;font-size:.95rem}
    img.flag{width:40px;height:auto;border-radius:4px}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #2a5298;border-radius:50%;width:34px;height:34px;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .refresh-btn{background:#4caf50;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .sort-ind{font-size:.8rem;opacity:.7;margin-left:6px}
    .small-muted{font-size:.85rem;color:#666}
    /* small screens */
    @media (max-width:700px){ .details-content{grid-template-columns:1fr} .stat-value{font-size:1.25rem} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚öîÔ∏è Politics & War Data Viewer</h1>
      <div class="small-muted">In-page nation detail, IndexedDB cache, full paginated nation summaries.</div>
    </header>

    <div class="status-bar" aria-live="polite">
      <div class="status-item"><div class="status-indicator" id="conn-indicator"></div><div id="status-text">Initializing...</div></div>
      <div class="status-item"><div id="last-update">Last updated: Never</div></div>
      <div class="status-item"><button class="refresh-btn" id="refresh-btn">üîÑ Refresh Now</button></div>
      <div class="status-item"><div id="next-update">Next update in: --:--</div></div>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="alliances">Alliances</button>
      <button class="tab" data-tab="nations">Nations</button>
      <button class="tab" data-tab="cities">Cities</button>
    </div>

    <div class="content">
      <!-- ALLIANCES -->
      <section id="alliances-section" class="section active" aria-labelledby="alliances-tab">
        <div class="stats" id="alliance-stats"></div>
        <input id="alliancesSearch" class="search-box" placeholder="üîç Search alliances by name or acronym..." />
        <div class="pagination" id="alliances-pagination">
          <button id="alliances-prev">‚Üê Prev</button>
          <div class="page-info" id="alliances-page-info">Page 1</div>
          <button id="alliances-next">Next ‚Üí</button>
        </div>
        <div id="alliances-loading" class="loading"><div class="spinner"></div><div class="small-muted">Loading alliances‚Ä¶</div></div>
        <table id="alliancesTable" style="display:none">
          <thead>
            <tr>
              <th data-key="flag">Flag</th>
              <th data-key="id" class="sortable">ID <span class="sort-ind" id="sort-alliance-id"></span></th>
              <th data-key="name" class="sortable">Name <span class="sort-ind" id="sort-alliance-name"></span></th>
              <th data-key="acronym" class="sortable">Acronym</th>
              <th data-key="rank" class="sortable">Rank</th>
              <th data-key="score" class="sortable">Score</th>
              <th data-key="date">Founded</th>
              <th>Recruiting</th>
              <th>Discord</th>
              <th>Wiki</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- NATIONS -->
      <section id="nations-section" class="section" aria-labelledby="nations-tab">
        <div class="stats" id="nation-stats"></div>
        <input id="nationsSearch" class="search-box" placeholder="üîç Search nations by name or leader..." />
        <div class="pagination" id="nations-pagination">
          <button id="nations-prev">‚Üê Prev</button>
          <div class="page-info" id="nations-page-info">Page 1</div>
          <button id="nations-next">Next ‚Üí</button>
        </div>
        <div id="nations-loading" class="loading"><div class="spinner"></div><div class="small-muted">Loading nations‚Ä¶</div></div>
        <table id="nationsTable" style="display:none">
          <thead>
            <tr>
              <th data-key="flag">Flag</th>
              <th data-key="nation_name" class="sortable">Nation <span class="sort-ind" id="sort-nation-name"></span></th>
              <th data-key="leader_name" class="sortable">Leader</th>
              <th data-key="continent" class="sortable">Continent</th>
              <th data-key="score" class="sortable">Score</th>
              <th data-key="num_cities" class="sortable">Cities</th>
              <th data-key="color">Color</th>
              <th data-key="alliance_name">Alliance</th>
              <th data-key="alliance_position">Position</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- NATION DETAIL (in-page) -->
      <section id="nation-detail-section" class="section" aria-live="polite">
        <button class="refresh-btn" id="back-to-nations">‚Üê Back to Nations</button>
        <div id="nation-detail-content" style="margin-top:12px"></div>
      </section>

      <!-- CITIES -->
      <section id="cities-section" class="section">
        <div class="stats" id="city-stats"></div>
        <input id="citiesSearch" class="search-box" placeholder="üîç Search cities by name or nation..." />
        <div class="pagination" id="cities-pagination">
          <button id="cities-prev">‚Üê Prev</button>
          <div class="page-info" id="cities-page-info">Page 1</div>
          <button id="cities-next">Next ‚Üí</button>
        </div>
        <div id="cities-loading" class="loading"><div class="spinner"></div><div class="small-muted">Loading cities‚Ä¶</div></div>
        <table id="citiesTable" style="display:none">
          <thead>
            <tr>
              <th></th>
              <th data-key="name" class="sortable">City Name</th>
              <th data-key="nation_name" class="sortable">Nation</th>
              <th data-key="infrastructure" class="sortable">Infrastructure</th>
              <th data-key="land" class="sortable">Land</th>
              <th data-key="powered" class="sortable">Powered</th>
              <th data-key="population" class="sortable">Population</th>
              <th data-key="age" class="sortable">Age (days)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const API = "https://philip-cap-judges-groove.trycloudflare.com"; // replace if needed
    const CACHE_DURATION = 15 * 60 * 1000; // 15 minutes
    const ITEMS_PER_PAGE = 100;

    // State
    let alliances = [];
    let nations = [];          // summaries (all pages)
    let nationDetails = {};    // id -> full nation object (cached)
    let cities = [];           // extracted from nationDetails
    let lastFetchTime = 0;

    // UI paging/filtering/sorting state
    let filteredAlliances = [];
    let filteredNations = [];
    let filteredCities = [];
    let alliancePage = 1, nationPage = 1, cityPage = 1;
    let sortState = { section: null, key: null, dir: 1 }; // dir: 1 asc, -1 desc

    // IndexedDB
    const DB_NAME = 'pnw_viewer_db';
    const DB_VERSION = 1;
    const STORE_NAME = 'game_data';
    let db = null;

    function openDatabase() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => resolve(req.result);
        req.onupgradeneeded = (e) => {
          const database = e.target.result;
          if (!database.objectStoreNames.contains(STORE_NAME)) {
            database.createObjectStore(STORE_NAME);
          }
        };
      });
    }

    async function saveCache() {
      try {
        if (!db) db = await openDatabase();
        const tx = db.transaction([STORE_NAME], 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const payload = {
          alliances, nations, nationDetails, timestamp: lastFetchTime, version: '2.0'
        };
        store.put(payload, 'cached_data');
        await new Promise((res, rej) => {
          tx.oncomplete = res;
          tx.onerror = () => rej(tx.error);
        });
        console.log('‚úì Saved cache to IndexedDB');
      } catch (e) {
        console.error('Failed saving cache:', e);
      }
    }

    async function loadCache() {
      try {
        if (!db) db = await openDatabase();
        const tx = db.transaction([STORE_NAME], 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.get('cached_data');
        const data = await new Promise((resolve, reject) => {
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
        if (data) {
          alliances = data.alliances || [];
          nations = data.nations || [];
          nationDetails = data.nationDetails || {};
          lastFetchTime = data.timestamp || 0;
          filteredAlliances = [...alliances];
          filteredNations = [...nations];
          extractCitiesFromDetails();
          console.log('‚úì Loaded cache from IndexedDB');
          return true;
        }
      } catch (e) {
        console.error('Failed loading cache:', e);
      }
      return false;
    }

    function extractCitiesFromDetails() {
      cities = [];
      Object.values(nationDetails).forEach(n => {
        if (Array.isArray(n.cities)) {
          n.cities.forEach(city => {
            const augmented = {
              ...city,
              nation_name: n.nation_name,
              nation_id: n.id,
              nation_leader: n.leader_name,
              population: Math.floor((city.infrastructure || 0) * 100),
              age: city.date ? Math.floor((Date.now() - new Date(city.date)) / (1000*60*60*24)) : 0
            };
            cities.push(augmented);
          });
        }
      });
      filteredCities = [...cities];
    }

    function isCacheValid() {
      return lastFetchTime && (Date.now() - lastFetchTime) < CACHE_DURATION;
    }

    // UI helpers
    function setStatus(text, ok = true) {
      document.getElementById('status-text').textContent = text;
      document.getElementById('conn-indicator').style.background = ok ? '#4caf50' : '#ff6b6b';
    }
    function updateTimers() {
      const last = lastFetchTime ? new Date(lastFetchTime) : null;
      document.getElementById('last-update').textContent = last ? `Last updated: ${last.toLocaleString()}` : 'Last updated: Never';
      if (!last) { document.getElementById('next-update').textContent = 'Next update in: --:--'; return; }
      const remaining = Math.max(0, CACHE_DURATION - (Date.now() - lastFetchTime));
      if (remaining <= 0) { document.getElementById('next-update').textContent = 'Next update in: Updating...'; return; }
      const m = Math.floor(remaining / 60000);
      const s = Math.floor((remaining % 60000)/1000);
      document.getElementById('next-update').textContent = `Next update in: ${m}:${String(s).padStart(2,'0')}`;
    }

    // Sorting
    function applySort(list, key) {
      if (!key) return list;
      const dir = sortState.dir;
      return list.slice().sort((a,b)=>{
        const A = (a[key] === undefined || a[key] === null) ? '' : a[key];
        const B = (b[key] === undefined || b[key] === null) ? '' : b[key];
        if (typeof A === 'number' && typeof B === 'number') return (A - B) * dir;
        return String(A).localeCompare(String(B), undefined, {numeric:true}) * dir;
      });
    }
    function setSort(section, key) {
      if (sortState.section === section && sortState.key === key) {
        sortState.dir = -sortState.dir; // toggle
      } else {
        sortState.section = section;
        sortState.key = key;
        sortState.dir = 1;
      }
      renderAll();
    }

    // Attach click-to-sort to table headers
    document.addEventListener('click', (e) => {
      const th = e.target.closest('th.sortable');
      if (!th) return;
      const key = th.getAttribute('data-key') || th.textContent.trim().toLowerCase();
      const table = th.closest('table');
      if (!table) return;
      const section = table.id.includes('alliances') ? 'alliances' : table.id.includes('nations') ? 'nations' : 'cities';
      setSort(section, key);
    });

    // Fetching: alliances + nations summaries (all pages) + on-demand full nation
    async function fetchAllNationsSummaries() {
      // fetch paginated summaries until empty or error
      let page = 1;
      const perPage = 500; // backend supports limit param per your API
      const all = [];
      while (true) {
        try {
          const res = await fetch(`${API}/nations/summary?page=${page}&limit=${perPage}`, {method:'POST'});
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          const pageNations = payload.nations || [];
          if (!pageNations.length) break;
          // Only keep basics: id, nation_name, leader_name, flag, score, num_cities, continent, color, alliance_name, alliance_position
          pageNations.forEach(n=>{
            all.push({
              id: n.id,
              nation_name: n.nation_name,
              leader_name: n.leader_name,
              flag: n.flag,
              score: n.score,
              num_cities: n.num_cities,
              continent: n.continent,
              color: n.color,
              alliance_name: n.alliance_name || (n.alliance && n.alliance.name) || null,
              alliance_position: n.alliance_position || n.position || null,
            });
          });
          if (pageNations.length < perPage) break;
          page++;
        } catch (e) {
          console.error('Error fetching nations summary page', page, e);
          break;
        }
      }
      return all;
    }

    async function fetchAllData(force=false) {
      // if cache valid and not forced, use cached
      if (!force && isCacheValid() && alliances.length && nations.length) {
        setStatus('Loaded from cache', true);
        return;
      }
      setStatus('Fetching data‚Ä¶', true);
      document.getElementById('alliances-loading').style.display = '';
      document.getElementById('nations-loading').style.display = '';
      document.getElementById('cities-loading').style.display = '';

      try {
        // alliances
        const alliancesReq = fetch(`${API}/alliance`, {method:'POST'}).then(r=>r.json()).catch(e=>{console.error(e); return {alliances:[]};});
        // nations (summaries) ‚Äî multiple pages internally
        const nationsReq = fetchAllNationsSummaries();

        const [alliancesResp, nationsResp] = await Promise.all([alliancesReq, nationsReq]);

        alliances = (alliancesResp && alliancesResp.alliances) ? alliancesResp.alliances : alliancesResp || [];
        nations = nationsResp || [];

        // update filtered copies
        filteredAlliances = [...alliances];
        filteredNations = [...nations];

        lastFetchTime = Date.now();
        await saveCache();
        extractCitiesFromDetails();
        updateStats();
        renderAll();
        setStatus('Connected', true);
      } catch (e) {
        console.error('FetchAllData failed', e);
        setStatus('Connection error', false);
      } finally {
        document.getElementById('alliances-loading').style.display = 'none';
        document.getElementById('nations-loading').style.display = 'none';
        document.getElementById('cities-loading').style.display = 'none';
        updateTimers();
      }
    }

    // Fetch a single nation's full detail (on demand)
    async function fetchNationDetail(nationId) {
      if (nationDetails[nationId]) return nationDetails[nationId];
      try {
        const res = await fetch(`${API}/nations/${nationId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data.nation) {
          nationDetails[nationId] = data.nation;
          await saveCache();
          extractCitiesFromDetails();
          updateStats();
          renderCities(); // update cities table if needed
          return data.nation;
        }
      } catch (e) {
        console.error('fetchNationDetail error', e);
      }
      return null;
    }

    // === RENDERING ===
    function paginate(list, page) {
      const total = Math.max(1, Math.ceil(list.length / ITEMS_PER_PAGE));
      const idx = Math.min(Math.max(1, page), total);
      const start = (idx - 1) * ITEMS_PER_PAGE;
      return { page: idx, total, data: list.slice(start, start + ITEMS_PER_PAGE) };
    }

    // Alliances table render
    function renderAlliances() {
      const table = document.getElementById('alliancesTable');
      const tbody = table.querySelector('tbody');
      // apply search filter (already in filteredAlliances) and sort
      let list = applySort(filteredAlliances, sortState.section === 'alliances' ? sortState.key : null);
      const p = paginate(list, alliancePage);
      tbody.innerHTML = '';
      p.data.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.flag ? `<img class="flag" src="${a.flag}" alt="flag">` : '‚Äî'}</td>
          <td>${a.id ?? '‚Äî'}</td>
          <td><strong>${a.name ?? '‚Äî'}</strong></td>
          <td>${a.acronym ?? '‚Äî'}</td>
          <td>${a.rank ?? '‚Äî'}</td>
          <td>${a.score ? Number(a.score).toLocaleString() : '‚Äî'}</td>
          <td>${a.date ? new Date(a.date).toLocaleDateString() : '‚Äî'}</td>
          <td>${a.accept_members ? '‚úÖ' : '‚Äî'}</td>
          <td>${a.discord_link ? `<a href="${a.discord_link}" target="_blank" rel="noopener">Join</a>` : '‚Äî'}</td>
          <td>${a.wiki_link ? `<a href="${a.wiki_link}" target="_blank" rel="noopener">View</a>` : '‚Äî'}</td>
        `;
        tbody.appendChild(tr);
      });
      table.style.display = p.data.length ? 'table' : 'none';
      document.getElementById('alliances-page-info').textContent = `Page ${p.page} of ${p.total} (${list.length} total)`;
      document.getElementById('alliances-prev').disabled = p.page === 1;
      document.getElementById('alliances-next').disabled = p.page === p.total;
    }

    // Nations table render
    function renderNations() {
      const table = document.getElementById('nationsTable');
      const tbody = table.querySelector('tbody');
      let list = applySort(filteredNations, sortState.section === 'nations' ? sortState.key : null);
      const p = paginate(list, nationPage);
      tbody.innerHTML = '';
      p.data.forEach(n=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${n.flag ? `<img class="flag" src="${n.flag}" alt="flag">` : '‚Äî'}</td>
          <td><strong>${n.nation_name ?? '‚Äî'}</strong></td>
          <td>${n.leader_name ?? '‚Äî'}</td>
          <td>${n.continent ?? '‚Äî'}</td>
          <td>${n.score ? Number(n.score).toLocaleString() : '‚Äî'}</td>
          <td>${n.num_cities ?? '‚Äî'}</td>
          <td style="color:${n.color ?? '#000'}">${n.color ? '‚¨§ ' + n.color : '‚Äî'}</td>
          <td>${n.alliance_name ?? '‚Äî'}</td>
          <td>${n.alliance_position ?? '‚Äî'}</td>
        `;
        tr.addEventListener('click', async () => {
          await openNationDetail(n.id);
        });
        tbody.appendChild(tr);
      });
      table.style.display = p.data.length ? 'table' : 'none';
      document.getElementById('nations-page-info').textContent = `Page ${p.page} of ${p.total} (${list.length} total)`;
      document.getElementById('nations-prev').disabled = p.page === 1;
      document.getElementById('nations-next').disabled = p.page === p.total;
    }

    // Cities render
    function renderCities() {
      const table = document.getElementById('citiesTable');
      const tbody = table.querySelector('tbody');
      // Ensure each city has population & age
      filteredCities = filteredCities.map(c => ({...c, population: c.population ?? Math.floor((c.infrastructure||0)*100), age: c.age ?? 0}));
      let list = applySort(filteredCities, sortState.section === 'cities' ? sortState.key : null);
      const p = paginate(list, cityPage);
      tbody.innerHTML = '';
      p.data.forEach(c=>{
        const tr = document.createElement('tr');
        tr.setAttribute('data-city-id', c.id);
        tr.innerHTML = `
          <td>‚ñ∂</td>
          <td><strong>${c.name ?? '‚Äî'}</strong></td>
          <td>${c.nation_name ?? '‚Äî'}</td>
          <td>${c.infrastructure ? Number(c.infrastructure).toLocaleString() : '‚Äî'}</td>
          <td>${c.land ? Number(c.land).toLocaleString() : '‚Äî'}</td>
          <td>${c.powered ? '‚úÖ' : '‚ùå'}</td>
          <td>${c.population ? Number(c.population).toLocaleString() : '‚Äî'}</td>
          <td>${c.age ?? 0} days</td>
        `;
        tr.addEventListener('click', () => toggleCityDetails(c.id));
        tbody.appendChild(tr);
      });
      table.style.display = p.data.length ? 'table' : 'none';
      document.getElementById('cities-page-info').textContent = `Page ${p.page} of ${p.total} (${list.length} total)`;
      document.getElementById('cities-prev').disabled = p.page === 1;
      document.getElementById('cities-next').disabled = p.page === p.total;
    }

    function renderAll() {
      updateStats();
      renderAlliances();
      renderNations();
      renderCities();
      updateTimers();
      // update sort indicators visually (basic)
      document.querySelectorAll('.sort-ind').forEach(el => el.textContent = '');
      if (sortState.section && sortState.key) {
        const id = `sort-${sortState.section}-${sortState.key}`.replace(/\s+/g,'-');
        // instead of specific ids, find the matching header's sort-ind
        const header = document.querySelector(`table#${sortState.section === 'alliances' ? 'alliancesTable' : sortState.section === 'nations' ? 'nationsTable' : 'citiesTable'} th[data-key="${sortState.key}"] .sort-ind`);
        if (header) header.textContent = sortState.dir === 1 ? '‚ñ≤' : '‚ñº';
      }
    }

    function updateStats() {
      // alliances stats
      document.getElementById('alliance-stats').innerHTML = `
        <div class="stat-card"><div class="stat-value">${alliances.length}</div><div class="stat-label">Total Alliances</div></div>
        <div class="stat-card"><div class="stat-value">${alliances.filter(a=>a.accept_members).length}</div><div class="stat-label">Recruiting</div></div>
        <div class="stat-card"><div class="stat-value">${alliances.filter(a=>a.discord_link).length}</div><div class="stat-label">With Discord</div></div>
      `;
      // nations stats
      const totalCities = nations.reduce((s,n)=> s + (n.num_cities || 0), 0);
      const avgScore = nations.length ? (nations.reduce((s,n)=> s + (Number(n.score)||0),0)/nations.length).toFixed(2) : 0;
      document.getElementById('nation-stats').innerHTML = `
        <div class="stat-card"><div class="stat-value">${nations.length}</div><div class="stat-label">Nation Summaries</div></div>
        <div class="stat-card"><div class="stat-value">${totalCities.toLocaleString()}</div><div class="stat-label">Total Cities</div></div>
        <div class="stat-card"><div class="stat-value">${avgScore}</div><div class="stat-label">Avg Score</div></div>
      `;
      // cities stats
      const totalInfra = cities.reduce((s,c)=> s + (Number(c.infrastructure)||0), 0);
      const powered = cities.filter(c=>c.powered).length;
      document.getElementById('city-stats').innerHTML = `
        <div class="stat-card"><div class="stat-value">${cities.length}</div><div class="stat-label">Cities (from details)</div></div>
        <div class="stat-card"><div class="stat-value">${totalInfra.toLocaleString()}</div><div class="stat-label">Total Infrastructure</div></div>
        <div class="stat-card"><div class="stat-value">${powered}</div><div class="stat-label">Powered Cities</div></div>
      `;
    }

    // Toggle city details under row (in-table)
    const expandedCityRows = new Set();
    function toggleCityDetails(cityId) {
      const existing = document.getElementById(`city-details-${cityId}`);
      const mainRow = document.querySelector(`tr[data-city-id="${cityId}"]`);
      if (!mainRow) return;
      if (existing) {
        existing.remove();
        expandedCityRows.delete(cityId);
        mainRow.classList.remove('expanded');
        return;
      }
      const city = cities.find(c=>c.id === cityId);
      if (!city) return;
      const detailsRow = document.createElement('tr');
      detailsRow.id = `city-details-${cityId}`;
      detailsRow.className = 'details-row show';
      const td = document.createElement('td');
      td.colSpan = 8;
      td.className = 'details-cell';
      td.innerHTML = `
        <div class="details-content">
          <div class="detail-group">
            <h4>City Info</h4>
            <div class="detail-item"><span class="detail-label">ID</span><span>${city.id}</span></div>
            <div class="detail-item"><span class="detail-label">Name</span><span>${city.name || '‚Äî'}</span></div>
            <div class="detail-item"><span class="detail-label">Nation</span><span>${city.nation_name}</span></div>
            <div class="detail-item"><span class="detail-label">Age</span><span>${city.age} days</span></div>
          </div>
          <div class="detail-group">
            <h4>Power & Resources</h4>
            <div class="detail-item"><span class="detail-label">Powered</span><span>${city.powered ? 'Yes' : 'No'}</span></div>
            <div class="detail-item"><span class="detail-label">Coal</span><span>${city.coal_power || 0}</span></div>
            <div class="detail-item"><span class="detail-label">Oil</span><span>${city.oil_power || 0}</span></div>
            <div class="detail-item"><span class="detail-label">Nuclear</span><span>${city.nuclear_power || 0}</span></div>
            <div class="detail-item"><span class="detail-label">Wind</span><span>${city.wind_power || 0}</span></div>
          </div>
          <div class="detail-group">
            <h4>Infrastructure</h4>
            <div class="detail-item"><span class="detail-label">Hospital</span><span>${city.hospital || 0}</span></div>
            <div class="detail-item"><span class="detail-label">Police</span><span>${city.police_station || 0}</span></div>
            <div class="detail-item"><span class="detail-label">Factory</span><span>${city.factory || 0}</span></div>
            <div class="detail-item"><span class="detail-label">Stadium</span><span>${city.stadium || 0}</span></div>
          </div>
        </div>
      `;
      detailsRow.appendChild(td);
      mainRow.after(detailsRow);
      expandedCityRows.add(cityId);
      mainRow.classList.add('expanded');
    }

    // Open nation detail (in-page) using cached full nation or fetching it
    async function openNationDetail(nationId) {
      const nation = await fetchNationDetail(nationId);
      if (!nation) {
        alert('Failed to load nation detail');
        return;
      }
      // hide others
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('nation-detail-section').classList.add('active');
      // render nation
      const content = document.getElementById('nation-detail-content');
      content.innerHTML = `
        <div class="nation-header">
          ${nation.flag ? `<img src="${nation.flag}" alt="flag" />` : ''}
          <div class="nation-header-info">
            <h2>${nation.nation_name || '‚Äî'}</h2>
            <p class="small-muted">Leader: ${nation.leader_name || '‚Äî'} | Score: ${Number(nation.score||0).toLocaleString()}</p>
          </div>
        </div>
        <div class="details-content">
          <div class="detail-group">
            <h4>Basic</h4>
            <div class="detail-item"><span class="detail-label">ID</span><span>${nation.id}</span></div>
            <div class="detail-item"><span class="detail-label">Founded</span><span>${nation.date ? new Date(nation.date).toLocaleDateString() : '‚Äî'}</span></div>
            <div class="detail-item"><span class="detail-label">Last Active</span><span>${nation.last_active ? new Date(nation.last_active).toLocaleString() : '‚Äî'}</span></div>
            <div class="detail-item"><span class="detail-label">Vacation</span><span>${nation.vacation_mode_turns ? 'Yes' : 'No'}</span></div>
          </div>
          <div class="detail-group">
            <h4>Military</h4>
            <div class="detail-item"><span class="detail-label">Soldiers</span><span>${(nation.soldiers||0).toLocaleString()}</span></div>
            <div class="detail-item"><span class="detail-label">Tanks</span><span>${(nation.tanks||0).toLocaleString()}</span></div>
            <div class="detail-item"><span class="detail-label">Aircraft</span><span>${(nation.aircraft||0).toLocaleString()}</span></div>
            <div class="detail-item"><span class="detail-label">Ships</span><span>${(nation.ships||0).toLocaleString()}</span></div>
          </div>
          <div class="detail-group">
            <h4>Economy & Infrastructure</h4>
            <div class="detail-item"><span class="detail-label">Cities</span><span>${nation.num_cities || 0}</span></div>
            <div class="detail-item"><span class="detail-label">Projects</span><span>${nation.projects || 0}</span></div>
            <div class="detail-item"><span class="detail-label">Score</span><span>${nation.score ? Number(nation.score).toLocaleString() : '‚Äî'}</span></div>
          </div>
        </div>

        <h3 style="margin-top:14px">Cities (${(nation.cities && nation.cities.length) || 0})</h3>
        <div class="cities-grid">
          ${(nation.cities && nation.cities.length) ? nation.cities.map(city=>`
            <div class="city-card" data-city-id="${city.id}">
              <h4>${city.name || 'Unnamed'}</h4>
              <div class="detail-item"><span class="detail-label">Infra</span><span>${Number(city.infrastructure||0).toLocaleString()}</span></div>
              <div class="detail-item"><span class="detail-label">Land</span><span>${Number(city.land||0).toLocaleString()}</span></div>
              <div class="detail-item"><span class="detail-label">Powered</span><span>${city.powered ? '‚úÖ' : '‚ùå'}</span></div>
              <div class="detail-item"><span class="detail-label">Age</span><span>${city.date ? Math.floor((Date.now()-new Date(city.date))/(1000*60*60*24)) + ' days' : '‚Äî'}</span></div>
            </div>
          `).join('') : '<p>No city data</p>'}
        </div>
      `;
      // Attach click events for those cards to open a city in cities tab (optional)
      content.querySelectorAll('.city-card').forEach(card=>{
        card.addEventListener('click', () => {
          const cid = card.getAttribute('data-city-id');
          // switch to cities tab and try to highlight / open
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          document.querySelector('.tab[data-tab="cities"]').classList.add('active');
          document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
          document.getElementById('cities-section').classList.add('active');
          // try to find city in global cities array; if not present it's OK
          const cidObj = cities.find(c=>String(c.id) === String(cid));
          if (cidObj) {
            // set filter and show page with that city
            filteredCities = cities.filter(c=>String(c.id) === String(cid));
            cityPage = 1;
            renderCities();
          }
        });
      });
    }

    // navigation / UI wiring
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        const tab = btn.getAttribute('data-tab');
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById(`${tab}-section`).classList.add('active');
        // reset query params in URL
        history.replaceState({}, '', window.location.pathname + `?view=${tab}`);
      });
    });

    // page prev/next handlers
    document.getElementById('alliances-prev').addEventListener('click', ()=>{ alliancePage = Math.max(1, alliancePage-1); renderAlliances(); });
    document.getElementById('alliances-next').addEventListener('click', ()=>{ alliancePage++; renderAlliances(); });

    document.getElementById('nations-prev').addEventListener('click', ()=>{ nationPage = Math.max(1, nationPage-1); renderNations(); });
    document.getElementById('nations-next').addEventListener('click', ()=>{ nationPage++; renderNations(); });

    document.getElementById('cities-prev').addEventListener('click', ()=>{ cityPage = Math.max(1, cityPage-1); renderCities(); });
    document.getElementById('cities-next').addEventListener('click', ()=>{ cityPage++; renderCities(); });

    // search
    document.getElementById('alliancesSearch').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      filteredAlliances = alliances.filter(a => (a.name||'').toLowerCase().includes(q) || (a.acronym||'').toLowerCase().includes(q));
      alliancePage = 1;
      renderAlliances();
    });
    document.getElementById('nationsSearch').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      filteredNations = nations.filter(n => (n.nation_name||'').toLowerCase().includes(q) || (n.leader_name||'').toLowerCase().includes(q));
      nationPage = 1;
      renderNations();
    });
    document.getElementById('citiesSearch').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      filteredCities = cities.filter(c => (c.name||'').toLowerCase().includes(q) || (c.nation_name||'').toLowerCase().includes(q));
      cityPage = 1;
      renderCities();
    });

    // back to nations button
    document.getElementById('back-to-nations').addEventListener('click', ()=>{
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('nations-section').classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelector('.tab[data-tab="nations"]').classList.add('active');
    });

    // refresh
    document.getElementById('refresh-btn').addEventListener('click', async ()=>{
      document.getElementById('refresh-btn').disabled = true;
      document.getElementById('refresh-btn').textContent = '‚è≥ Refreshing...';
      await fetchAllData(true);
      document.getElementById('refresh-btn').disabled = false;
      document.getElementById('refresh-btn').textContent = 'üîÑ Refresh Now';
    });

    // load on start
    async function init() {
      setStatus('Starting‚Ä¶', true);
      // try load cache
      await openDatabase().then(d=>db=d).catch(e=>console.warn('IndexedDB open failed', e));
      const loaded = await loadCache();
      if (loaded) {
        // render cached immediately
        filteredAlliances = [...alliances];
        filteredNations = [...nations];
        filteredCities = [...cities];
        renderAll();
        setStatus('Loaded from cache', true);
      } else {
        setStatus('No cache ‚Äî fetching‚Ä¶', true);
      }

      // fetch fresh data if cache expired or missing
      if (!isCacheValid()) {
        await fetchAllData(true);
      } else {
        // schedule background refresh at end of cache duration
        setStatus('Using cached data', true);
      }

      // update timers and schedule auto refresh every CACHE_DURATION
      updateTimers();
      setInterval(async ()=>{ await fetchAllData(true); }, CACHE_DURATION);
      setInterval(updateTimers, 1000);
    }

    // restore view from URL if requested
    function loadFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');
      const id = params.get('id');
      if (view === 'nation' && id) {
        // try open nation detail (will load full data if needed)
        openNationDetail(id).catch(()=>{});
        return;
      }
      if (view) {
        const tabBtn = document.querySelector(`.tab[data-tab="${view}"]`);
        if (tabBtn) tabBtn.click();
      }
    }

    // Start
    init().then(()=>loadFromUrl()).catch(e=>console.error(e));

    // Expose a couple debugging helpers if needed
    window._pnw = {
      fetchAllData, fetchNationDetail, saveCache, loadCache, _state: ()=>({alliances,nations,Object_keys_nationDetails:Object.keys(nationDetails)})
    };
  </script>
</body>
</html>
