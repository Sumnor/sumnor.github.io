<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Politics & War - Data Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    header { text-align: center; color: white; margin-bottom: 30px; }
    h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .status-bar { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; color: white; backdrop-filter: blur(10px); flex-wrap: wrap; gap: 15px; }
    .status-item { display: flex; align-items: center; gap: 10px; }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: #4caf50; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .tabs { display: flex; gap: 10px; margin-bottom: 0; }
    .tab { padding: 15px 30px; background: rgba(255,255,255,0.2); border: none; border-radius: 10px 10px 0 0; color: white; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px); }
    .tab:hover { background: rgba(255,255,255,0.3); }
    .tab.active { background: white; color: #1e3c72; }
    .content { background: white; border-radius: 0 10px 10px 10px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .section { display: none; }
    .section.active { display: block; }
    .search-box { width: 100%; padding: 12px 20px; font-size: 1em; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px; transition: border-color 0.3s; }
    .search-box:focus { outline: none; border-color: #2a5298; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
    .stat-value { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
    .stat-label { font-size: 0.9em; opacity: 0.9; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    .pagination button { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: background 0.3s; }
    .pagination button:hover:not(:disabled) { background: #5568d3; }
    .pagination button:disabled { background: #ccc; cursor: not-allowed; }
    .pagination .page-info { padding: 8px 16px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    th { padding: 15px 10px; text-align: left; font-weight: 600; position: sticky; top: 0; }
    td { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; }
    tbody tr { transition: background-color 0.2s; cursor: pointer; }
    tbody tr:hover { background-color: #f5f5f5; }
    tbody tr.expanded { background-color: #e8f4f8; }
    .details-row { display: none; }
    .details-row.show { display: table-row; }
    .details-cell { padding: 20px !important; background: #f8f9fa; border-left: 4px solid #667eea; }
    .details-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
    .detail-group { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .detail-group h4 { margin-bottom: 10px; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 5px; }
    .detail-item { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
    .detail-label { font-weight: 600; color: #666; }
    .detail-value { color: #333; }
    .nation-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; display: flex; align-items: center; gap: 20px; }
    .nation-header img { width: 80px; height: auto; border-radius: 8px; border: 3px solid white; }
    .nation-header-info h2 { font-size: 2em; margin-bottom: 10px; }
    .nation-header-info p { opacity: 0.9; font-size: 1.1em; }
    .cities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
    .city-card { background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.3s; cursor: pointer; }
    .city-card:hover { border-color: #667eea; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: translateY(-2px); }
    .city-card h4 { color: #667eea; margin-bottom: 10px; }
    img.flag { width: 40px; height: auto; border-radius: 4px; }
    a { color: #2a5298; text-decoration: none; font-weight: 500; }
    a:hover { text-decoration: underline; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2a5298; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .refresh-btn { background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: background 0.3s; }
    .refresh-btn:hover { background: #45a049; }
    .refresh-btn:disabled { background: #ccc; cursor: not-allowed; }
    .expand-icon { display: inline-block; transition: transform 0.3s; margin-right: 5px; }
    .expand-icon.rotated { transform: rotate(90deg); }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>‚öîÔ∏è Politics & War Data Viewer</h1>
    <p>Real-time alliance and nation statistics</p>
  </header>

  <div class="status-bar">
    <div class="status-item">
      <div class="status-indicator"></div>
      <span id="status-text">Connected</span>
    </div>
    <div class="status-item">
      <span id="last-update">Last updated: Never</span>
    </div>
    <div class="status-item">
      <button class="refresh-btn" id="refresh-btn">üîÑ Refresh Now</button>
    </div>
    <div class="status-item">
      <span id="next-update">Next update in: 15:00</span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('alliances')">Alliances</button>
    <button class="tab" onclick="switchTab('nations')">Nations</button>
    <button class="tab" onclick="switchTab('cities')">Cities</button>
  </div>

  <div class="content">
    <!-- ALLIANCES -->
    <div id="alliances-section" class="section active">
      <div class="stats" id="alliance-stats"></div>
      <input type="text" id="alliancesSearch" class="search-box" placeholder="üîç Search alliances by name or acronym...">
      <div class="pagination" id="alliances-pagination">
        <button onclick="changeAlliancePage(-1)">‚Üê Previous</button>
        <span class="page-info" id="alliances-page-info">Page 1</span>
        <button onclick="changeAlliancePage(1)">Next ‚Üí</button>
      </div>
      <div id="alliances-loading" class="loading">
        <div class="spinner"></div>
        <p>Loading alliances data...</p>
      </div>
      <table id="alliancesTable" style="display:none;">
        <thead>
          <tr>
            <th>Flag</th><th>ID</th><th>Name</th><th>Acronym</th><th>Rank</th><th>Score</th><th>Founded</th><th>Recruiting</th><th>Discord</th><th>Wiki</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- NATIONS -->
    <div id="nations-section" class="section">
      <div class="stats" id="nation-stats"></div>
      <input type="text" id="nationsSearch" class="search-box" placeholder="üîç Search nations by name or leader...">
      <div class="pagination" id="nations-pagination">
        <button onclick="changeNationPage(-1)">‚Üê Previous</button>
        <span class="page-info" id="nations-page-info">Page 1</span>
        <button onclick="changeNationPage(1)">Next ‚Üí</button>
      </div>
      <div id="nations-loading" class="loading">
        <div class="spinner"></div>
        <p>Loading nations data...</p>
      </div>
      <table id="nationsTable" style="display:none;">
        <thead>
          <tr>
            <th>Flag</th><th>Nation</th><th>Leader</th><th>Continent</th><th>Score</th><th>Cities</th><th>Color</th><th>Alliance</th><th>Position</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- NATION DETAIL -->
    <div id="nation-detail-section" class="section"></div>

    <!-- CITIES -->
    <div id="cities-section" class="section">
      <div class="stats" id="city-stats"></div>
      <input type="text" id="citiesSearch" class="search-box" placeholder="üîç Search cities by name or nation...">
      <div class="pagination" id="cities-pagination">
        <button onclick="changeCityPage(-1)">‚Üê Previous</button>
        <span class="page-info" id="cities-page-info">Page 1</span>
        <button onclick="changeCityPage(1)">Next ‚Üí</button>
      </div>
      <div id="cities-loading" class="loading">
        <div class="spinner"></div>
        <p>Loading cities data...</p>
      </div>
      <table id="citiesTable" style="display:none;">
        <thead>
          <tr><th></th><th>City Name</th><th>Nation</th><th>Infrastructure</th><th>Land</th><th>Powered</th><th>Population</th><th>Age</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API = "https://philip-cap-judges-groove.trycloudflare.com";
const CACHE_DURATION = 15*60*1000;
const ITEMS_PER_PAGE = 100;

let alliances=[], nations=[], cities=[], nationDetails={}, filteredAlliances=[], filteredNations=[], filteredCities=[];
let currentAlliancePage=1, currentNationPage=1, currentCityPage=1, lastFetchTime=0;
let expandedCities=new Set();

async function fetchData(force=false){
  if(!force && (Date.now()-lastFetchTime)<CACHE_DURATION && alliances.length) return;
  try{
    document.getElementById('status-text').textContent='Fetching data...';
    const [aRes,nRes]=await Promise.all([
      fetch(`${API}/alliance`,{method:"POST"}), 
      fetch(`${API}/nations/summary?page=1&limit=50000`,{method:"POST"})
    ]);
    const aData=await aRes.json(), nData=await nRes.json();
    alliances=aData.alliances||[]; nations=nData.nations||[];
    filteredAlliances=[...alliances]; filteredNations=[...nations];
    lastFetchTime=Date.now();
    renderAlliances(); renderNations();
    extractCitiesFromDetails(); renderCities(); updateStats();
    document.getElementById('status-text').textContent='Connected';
  }catch(e){ console.error(e); document.getElementById('status-text').textContent='Connection error'; }
}

function extractCitiesFromDetails(){
  cities=[];
  Object.values(nationDetails).forEach(n=>{
    if(n.cities?.length) n.cities.forEach(c=>cities.push({...c,nation_name:n.nation_name,nation_id:n.id,nation_leader:n.leader_name}));
  });
  filteredCities=[...cities];
}

function updateStats(){
  document.getElementById('alliance-stats').innerHTML=`<div class="stat-card"><div class="stat-value">${alliances.length}</div><div class="stat-label">Total Alliances</div></div>`;
  document.getElementById('nation-stats').innerHTML=`<div class="stat-card"><div class="stat-value">${nations.length}</div><div class="stat-label">Nations Loaded</div></div>`;
  document.getElementById('city-stats').innerHTML=`<div class="stat-card"><div class="stat-value">${cities.length}</div><div class="stat-label">Cities</div></div>`;
}

function renderAlliances(){
  const tbody=document.querySelector("#alliancesTable tbody"); tbody.innerHTML="";
  const start=(currentAlliancePage-1)*ITEMS_PER_PAGE; const end=start+ITEMS_PER_PAGE;
  filteredAlliances.slice(start,end).forEach(a=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${a.flag?`<img class="flag" src="${a.flag}">`:"‚Äî"}</td><td>${a.id||"‚Äî"}</td><td>${a.name||"‚Äî"}</td><td>${a.acronym||"‚Äî"}</td><td>${a.rank||"‚Äî"}</td><td>${a.score||"‚Äî"}</td><td>${a.date||"‚Äî"}</td><td>${a.accept_members?"‚úÖ":"‚ùå"}</td><td>${a.discord_link?`<a href="${a.discord_link}">Join</a>`:"‚Äî"}</td><td>${a.wiki_link?`<a href="${a.wiki_link}">View</a>`:"‚Äî"}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('alliancesTable').style.display='table';
}

function renderNations(){
  const tbody=document.querySelector("#nationsTable tbody"); tbody.innerHTML="";
  const start=(currentNationPage-1)*ITEMS_PER_PAGE; const end=start+ITEMS_PER_PAGE;
  filteredNations.slice(start,end).forEach(n=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${n.flag?`<img class="flag" src="${n.flag}">`:"‚Äî"}</td><td>${n.nation_name}</td><td>${n.leader_name}</td><td>${n.continent}</td><td>${n.score}</td><td>${n.cities?.length||0}</td><td>${n.color}</td><td>${n.alliance_name||"‚Äî"}</td><td>${n.position||"‚Äî"}</td>`;
    tr.onclick=()=>showNationDetail(n.id);
    tbody.appendChild(tr);
  });
  document.getElementById('nationsTable').style.display='table';
}

function renderCities(){
  const tbody=document.querySelector("#citiesTable tbody"); tbody.innerHTML="";
  const start=(currentCityPage-1)*ITEMS_PER_PAGE; const end=start+ITEMS_PER_PAGE;
  filteredCities.slice(start,end).forEach(c=>{
    const tr=document.createElement("tr");
    const expandIcon=document.createElement("span");
    expandIcon.textContent="‚ñ∂"; expandIcon.classList.add("expand-icon");
    if(expandedCities.has(c.id)) expandIcon.classList.add("rotated");
    tr.innerHTML=`<td></td><td>${c.name}</td><td>${c.nation_name}</td><td>${c.infrastructure}</td><td>${c.land}</td><td>${c.powered}</td><td>${c.population}</td><td>${c.age}</td>`;
    tr.querySelector("td:first-child").appendChild(expandIcon);
    tr.onclick=()=>toggleCityDetails(c,tr,expandIcon);
    tbody.appendChild(tr);
  });
  document.getElementById('citiesTable').style.display='table';
}

function toggleCityDetails(city,tr,icon){
  const next=tr.nextElementSibling;
  if(next?.classList.contains('details-row')){
    next.remove(); expandedCities.delete(city.id); icon.classList.remove('rotated'); return;
  }
  const details=document.createElement("tr"); details.classList.add('details-row','show');
  details.innerHTML=`<td colspan="8" class="details-cell"><div class="details-content"><div class="detail-group"><h4>City Info</h4><div class="detail-item"><span class="detail-label">ID</span><span class="detail-value">${city.id}</span></div><div class="detail-item"><span class="detail-label">Population</span><span class="detail-value">${city.population}</span></div><div class="detail-item"><span class="detail-label">Infrastructure</span><span class="detail-value">${city.infrastructure}</span></div><div class="detail-item"><span class="detail-label">Land</span><span class="detail-value">${city.land}</span></div></div></div></td>`;
  tr.parentNode.insertBefore(details,tr.nextSibling);
  expandedCities.add(city.id); icon.classList.add('rotated');
}

function showNationDetail(id){
  const nation=nations.find(n=>n.id===id); if(!nation) return;
  const section=document.getElementById('nation-detail-section'); section.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>{ if(s.id!=='nation-detail-section') s.classList.remove('active'); });
  let html=`<div class="nation-header"><img src="${nation.flag||''}"><div class="nation-header-info"><h2>${nation.nation_name}</h2><p>Leader: ${nation.leader_name}</p><p>Alliance: ${nation.alliance_name||"‚Äî"}</p></div></div>`;
  html+=`<div class="cities-grid">`;
  if(nation.cities?.length) nation.cities.forEach(c=>{
    html+=`<div class="city-card"><h4>${c.name}</h4><p>Population: ${c.population}</p><p>Infrastructure: ${c.infrastructure}</p></div>`;
  });
  html+=`</div>`;
  section.innerHTML=html;
}

function switchTab(tab){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(`${tab}-section`).classList.add('active');
}

function changeAlliancePage(delta){
  currentAlliancePage+=delta; if(currentAlliancePage<1) currentAlliancePage=1; renderAlliances();
}
function changeNationPage(delta){
  currentNationPage+=delta; if(currentNationPage<1) currentNationPage=1; renderNations();
}
function changeCityPage(delta){
  currentCityPage+=delta; if(currentCityPage<1) currentCityPage=1; renderCities();
}

document.getElementById('refresh-btn').onclick=()=>fetchData(true);
document.getElementById('alliancesSearch').oninput=e=>{
  filteredAlliances=alliances.filter(a=>a.name.toLowerCase().includes(e.target.value.toLowerCase())||a.acronym.toLowerCase().includes(e.target.value.toLowerCase()));
  renderAlliances();
};
document.getElementById('nationsSearch').oninput=e=>{
  filteredNations=nations.filter(n=>n.nation_name.toLowerCase().includes(e.target.value.toLowerCase())||n.leader_name.toLowerCase().includes(e.target.value.toLowerCase()));
  renderNations();
};
document.getElementById('citiesSearch').oninput=e=>{
  filteredCities=cities.filter(c=>c.name.toLowerCase().includes(e.target.value.toLowerCase())||c.nation_name.toLowerCase().includes(e.target.value.toLowerCase()));
  renderCities();
};

fetchData();
</script>
</body>
</html>
